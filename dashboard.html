<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - API Keys Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --dark-lighter: #334155;
            --light: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        /* Login Screen */
        #login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-lighter) 100%);
        }

        .login-card {
            background: var(--white);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
        }

        .login-card h1 {
            text-align: center;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }

        .login-card p {
            text-align: center;
            color: var(--secondary);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Dashboard */
        #dashboard {
            display: none;
        }

        /* Header */
        .header {
            background: var(--dark);
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Layout */
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--white);
            border-right: 1px solid var(--border);
            padding: 1.5rem 0;
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--light);
            color: var(--primary);
        }

        .nav-item.active {
            background: #eff6ff;
            color: var(--primary);
            border-left-color: var(--primary);
        }

        /* Content */
        .content {
            padding: 2rem;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.875rem;
            color: var(--secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .card-trend {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .card-trend.up {
            color: var(--success);
        }

        .card-trend.down {
            color: var(--danger);
        }

        /* Tables */
        .table-container {
            background: var(--white);
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
        }

        .table-actions {
            display: flex;
            gap: 0.75rem;
        }

        .search-box {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            width: 250px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-admin {
            background: #ede9fe;
            color: #5b21b6;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .checkbox-group label {
            margin-bottom: 0;
        }

        /* Toast notifications */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary);
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .sidebar.mobile-open {
                display: block;
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                z-index: 99;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats timeline */
        .timeline {
            background: var(--white);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            padding-bottom: 1.5rem;
            position: relative;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 1.25rem;
            top: 2rem;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: #dbeafe;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .timeline-meta {
            font-size: 0.875rem;
            color: var(--secondary);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <h1><i class="fas fa-key"></i> Dashboard Admin</h1>
            <p>API Keys Manager - @MutanoX</p>

            <form id="login-form">
                <div class="form-group">
                    <label for="api-key">Admin API Key</label>
                    <input
                        type="text"
                        id="api-key"
                        name="apiKey"
                        placeholder="Digite sua API Key de administrador"
                        required
                        autocomplete="off"
                    >
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </form>

            <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                <i class="fas fa-info-circle"></i> Use a API Key de administrador para acessar
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-server"></i> API Keys Manager</h1>
            <div class="header-actions">
                <div class="user-info">
                    <i class="fas fa-user-shield"></i>
                    <span id="user-name">Admin</span>
                </div>
                <button id="logout-btn" class="btn btn-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="nav-item active" data-page="overview">
                    <i class="fas fa-chart-line"></i>
                    <span>Visão Geral</span>
                </div>
                <div class="nav-item" data-page="keys">
                    <i class="fas fa-key"></i>
                    <span>API Keys</span>
                </div>
                <div class="nav-item" data-page="subscriptions">
                    <i class="fas fa-credit-card"></i>
                    <span>Assinaturas</span>
                </div>
                <div class="nav-item" data-page="revenue">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Receita</span>
                </div>
                <div class="nav-item" data-page="logs">
                    <i class="fas fa-history"></i>
                    <span>Logs</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </div>
            </aside>

            <!-- Content -->
            <main class="content">
                <!-- Overview Page -->
                <div id="page-overview" class="page active">
                    <div class="cards-grid" id="stats-cards">
                        <!-- Stats cards will be loaded here -->
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h2 class="table-title"><i class="fas fa-history"></i> Atividade Recente</h2>
                        </div>
                        <div class="table-wrapper">
                            <table id="recent-activity-table">
                                <thead>
                                    <tr>
                                        <th>Ação</th>
                                        <th>API Key</th>
                                        <th>Tipo</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Keys Page -->
                <div id="page-keys" class="page">
                    <div class="table-container">
                        <div class="table-header">
                            <h2 class="table-title"><i class="fas fa-key"></i> Gerenciar API Keys</h2>
                            <div class="table-actions">
                                <input type="text" class="search-box" id="keys-search" placeholder="Buscar...">
                                <button class="btn btn-primary btn-sm" id="create-key-btn">
                                    <i class="fas fa-plus"></i> Nova Key
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="keys-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>UID</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                        <th>Uso</th>
                                        <th>Assinatura</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Subscriptions Page -->
                <div id="page-subscriptions" class="page">
                    <div class="table-container">
                        <div class="table-header">
                            <h2 class="table-title"><i class="fas fa-credit-card"></i> Assinaturas</h2>
                            <div class="table-actions">
                                <select class="search-box" id="subscription-filter">
                                    <option value="all">Todas</option>
                                    <option value="active">Ativas</option>
                                    <option value="expiring">Expirando</option>
                                    <option value="expired">Expiradas</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="subscriptions-table">
                                <thead>
                                    <tr>
                                        <th>API Key</th>
                                        <th>Preço</th>
                                        <th>Status</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Dias Restantes</th>
                                        <th>Auto-Renovação</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Revenue Page -->
                <div id="page-revenue" class="page">
                    <div class="cards-grid" id="revenue-cards">
                        <!-- Revenue cards will be loaded here -->
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h2 class="table-title"><i class="fas fa-dollar-sign"></i> Pagamentos Recentes</h2>
                        </div>
                        <div class="table-wrapper">
                            <table id="payments-table">
                                <thead>
                                    <tr>
                                        <th>Referência</th>
                                        <th>API Key</th>
                                        <th>Valor</th>
                                        <th>Método</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Logs Page -->
                <div id="page-logs" class="page">
                    <div class="timeline" id="logs-timeline">
                        <!-- Logs will be loaded here -->
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="page-settings" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Configurações do Sistema</h2>
                        </div>
                        <form id="settings-form">
                            <div class="form-group">
                                <label>Admin API Key Atual</label>
                                <input type="text" value="MutanoX3397" readonly>
                            </div>
                            <div class="form-group">
                                <label>URL da API</label>
                                <input type="text" id="api-url" value="/api" placeholder="URL base da API">
                            </div>
                            <div class="form-group">
                                <label>Intervalo de Atualização (segundos)</label>
                                <input type="number" id="refresh-interval" value="5" min="1" max="60">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar
                            </button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Key Modal -->
    <div id="create-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nova API Key</h2>
                <button class="modal-close" id="close-create-modal">&times;</button>
            </div>
            <form id="create-key-form">
                <div class="form-group">
                    <label for="key-name">Nome *</label>
                    <input type="text" id="key-name" name="name" required placeholder="Ex: Cliente X">
                </div>
                <div class="form-group">
                    <label for="key-type">Tipo *</label>
                    <select id="key-type" name="type" required>
                        <option value="normal">Normal</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border);">

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enable-subscription" name="enableSubscription">
                        Habilitar Assinatura
                    </label>
                </div>

                <div id="subscription-options" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="subscription-price">Preço (R$)</label>
                            <input type="number" id="subscription-price" name="price" value="50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="subscription-duration">Duração (dias)</label>
                            <input type="number" id="subscription-duration" name="durationDays" value="30">
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="auto-renew" name="autoRenew">
                        <label for="auto-renew">Renovação Automática</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Criar API Key
                </button>
            </form>
        </div>
    </div>

    <!-- View Key Modal -->
    <div id="view-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes da API Key</h2>
                <button class="modal-close" id="close-view-modal">&times;</button>
            </div>
            <div id="view-key-content">
                <!-- Key details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Renew Subscription Modal -->
    <div id="renew-subscription-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Renovar Assinatura</h2>
                <button class="modal-close" id="close-renew-modal">&times;</button>
            </div>
            <form id="renew-subscription-form">
                <input type="hidden" id="renew-key-uid">
                <div class="form-group">
                    <label for="renew-duration">Duração (dias) *</label>
                    <input type="number" id="renew-duration" name="durationDays" value="30" required>
                </div>
                <div class="form-group">
                    <label for="renew-amount">Valor (R$)</label>
                    <input type="number" id="renew-amount" name="amount" step="0.01">
                </div>
                <div class="form-group">
                    <label for="renew-reference">Referência</label>
                    <input type="text" id="renew-reference" name="paymentReference" placeholder="Ex: REF-123456">
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-sync"></i> Renovar
                </button>
            </form>
        </div>
    </div>

    <script>
        // ==========================================
        // APP STATE
        // ==========================================
        const AppState = {
            isAuthenticated: false,
            token: null,
            refreshToken: null,
            currentView: 'overview',
            apiKeys: [],
            subscriptions: [],
            stats: {},
            autoRefreshInterval: null,
            inactivityTimer: null,
            API_URL: '/api'
        };

        // ==========================================
        // API CLIENT
        // ==========================================
        class APIClient {
            constructor() {
                this.baseURL = AppState.API_URL;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (AppState.token) {
                    defaultOptions.headers['Authorization'] = `Bearer ${AppState.token}`;
                }

                const finalOptions = {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers,
                    },
                };

                const response = await fetch(url, finalOptions);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || error.message || 'Request failed');
                }

                return response.json();
            }

            async login(apiKey) {
                const data = await this.request('/admin/auth/validate', {
                    method: 'POST',
                    body: JSON.stringify({ apiKey }),
                });
                return data;
            }

            async refresh() {
                const data = await this.request('/admin/auth/refresh');
                return data;
            }

            async logout() {
                await this.request('/admin/auth/logout', {
                    method: 'DELETE',
                });
            }

            async getKeys(filters = {}) {
                const params = new URLSearchParams(filters);
                return this.request(`/admin/keys?${params}`);
            }

            async getKey(keyOrUid) {
                return this.request(`/admin/keys/${keyOrUid}`);
            }

            async createKey(data) {
                return this.request('/admin/keys', {
                    method: 'POST',
                    body: JSON.stringify(data),
                });
            }

            async updateKey(keyOrUid, data) {
                return this.request(`/admin/keys/${keyOrUid}`, {
                    method: 'PUT',
                    body: JSON.stringify(data),
                });
            }

            async deleteKey(keyOrUid) {
                return this.request(`/admin/keys/${keyOrUid}`, {
                    method: 'DELETE',
                });
            }

            async activateSubscription(keyOrUid, data) {
                return this.request(`/admin/keys/${keyOrUid}/subscription/activate`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                });
            }

            async renewSubscription(keyOrUid, data) {
                return this.request(`/admin/keys/${keyOrUid}/subscription/renew`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                });
            }

            async cancelSubscription(keyOrUid) {
                return this.request(`/admin/keys/${keyOrUid}/subscription/cancel`, {
                    method: 'POST',
                });
            }

            async getExpiringSubscriptions(filters = {}) {
                const params = new URLSearchParams(filters);
                return this.request(`/admin/subscriptions/expiring?${params}`);
            }

            async getRevenue(filters = {}) {
                const params = new URLSearchParams(filters);
                return this.request(`/admin/subscriptions/revenue?${params}`);
            }

            async getStats() {
                return this.request('/admin/stats');
            }
        }

        const api = new APIClient();

        // ==========================================
        // TOAST NOTIFICATIONS
        // ==========================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            }[type] || 'fa-info-circle';

            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        async function handleLogin(e) {
            e.preventDefault();

            const apiKey = document.getElementById('api-key').value.trim();

            if (!apiKey) {
                showToast('Por favor, insira sua API Key', 'error');
                return;
            }

            try {
                const response = await api.login(apiKey);

                AppState.token = response.token;
                AppState.refreshToken = response.refreshToken;
                AppState.isAuthenticated = true;

                // Store token in sessionStorage
                sessionStorage.setItem('token', AppState.token);
                sessionStorage.setItem('refreshToken', AppState.refreshToken);

                showToast('Login realizado com sucesso!', 'success');

                showDashboard();
                loadDashboardData();
                startAutoRefresh();
                resetInactivityTimer();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function handleLogout() {
            try {
                await api.logout();
            } catch (error) {
                console.error('Logout error:', error);
            }

            // Clear state
            AppState.token = null;
            AppState.refreshToken = null;
            AppState.isAuthenticated = false;

            // Clear sessionStorage
            sessionStorage.clear();

            // Stop auto refresh
            stopAutoRefresh();

            showLoginScreen();
            showToast('Logout realizado', 'info');
        }

        async function checkAuth() {
            const token = sessionStorage.getItem('token');
            const refreshToken = sessionStorage.getItem('refreshToken');

            if (token && refreshToken) {
                AppState.token = token;
                AppState.refreshToken = refreshToken;
                AppState.isAuthenticated = true;

                showDashboard();
                loadDashboardData();
                startAutoRefresh();
                resetInactivityTimer();
            } else {
                showLoginScreen();
            }
        }

        async function refreshAuthToken() {
            try {
                const response = await api.refresh();
                AppState.token = response.token;
                AppState.refreshToken = response.refreshToken;

                sessionStorage.setItem('token', AppState.token);
                sessionStorage.setItem('refreshToken', AppState.refreshToken);
            } catch (error) {
                console.error('Token refresh failed:', error);
                handleLogout();
            }
        }

        // ==========================================
        // UI MANAGEMENT
        // ==========================================
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function switchPage(pageId) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                }
            });

            // Update pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.add('active');

            AppState.currentView = pageId;

            // Load data for the page
            if (pageId === 'overview') loadOverview();
            else if (pageId === 'keys') loadKeys();
            else if (pageId === 'subscriptions') loadSubscriptions();
            else if (pageId === 'revenue') loadRevenue();
            else if (pageId === 'logs') loadLogs();
        }

        // ==========================================
        // DATA LOADING
        // ==========================================
        async function loadDashboardData() {
            await loadOverview();
        }

        async function loadOverview() {
            try {
                const stats = await api.getStats();
                AppState.stats = stats;

                renderStatsCards(stats);
                renderRecentActivity(stats.recentActivity || []);
            } catch (error) {
                console.error('Error loading overview:', error);
                showToast('Erro ao carregar visão geral', 'error');
            }
        }

        async function loadKeys() {
            try {
                const data = await api.getKeys();
                AppState.apiKeys = data.apiKeys;
                renderKeysTable(data.apiKeys);
            } catch (error) {
                console.error('Error loading keys:', error);
                showToast('Erro ao carregar API Keys', 'error');
            }
        }

        async function loadSubscriptions() {
            try {
                const filter = document.getElementById('subscription-filter')?.value || 'all';
                const data = await api.getExpiringSubscriptions({ status: filter });
                AppState.subscriptions = data.subscriptions;
                renderSubscriptionsTable(data.subscriptions);
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                showToast('Erro ao carregar assinaturas', 'error');
            }
        }

        async function loadRevenue() {
            try {
                const stats = await api.getStats();
                const revenue = await api.getRevenue();

                renderRevenueCards(stats, revenue);
                renderPaymentsTable(revenue.recentPayments || []);
            } catch (error) {
                console.error('Error loading revenue:', error);
                showToast('Erro ao carregar receita', 'error');
            }
        }

        async function loadLogs() {
            try {
                const stats = await api.getStats();
                renderLogsTimeline(stats.recentActivity || []);
            } catch (error) {
                console.error('Error loading logs:', error);
                showToast('Erro ao carregar logs', 'error');
            }
        }

        // ==========================================
        // RENDERING
        // ==========================================
        function renderStatsCards(stats) {
            const container = document.getElementById('stats-cards');
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Total de Keys</span>
                        <i class="fas fa-key" style="color: var(--primary);"></i>
                    </div>
                    <div class="card-value">${stats.overview.totalKeys}</div>
                    <div class="card-trend">
                        <span class="badge badge-success">${stats.overview.activeKeys} ativas</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Assinaturas Ativas</span>
                        <i class="fas fa-credit-card" style="color: var(--success);"></i>
                    </div>
                    <div class="card-value">${stats.subscriptions.active}</div>
                    <div class="card-trend">
                        <span class="badge badge-warning">${stats.subscriptions.expiringSoon} expirando</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Receita Total</span>
                        <i class="fas fa-dollar-sign" style="color: var(--warning);"></i>
                    </div>
                    <div class="card-value">R$ ${stats.revenue.total.toFixed(2)}</div>
                    <div class="card-trend">
                        <span class="badge badge-info">Últimos 30 dias: R$ ${stats.revenue.last30Days.toFixed(2)}</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Requisições (24h)</span>
                        <i class="fas fa-chart-bar" style="color: var(--danger);"></i>
                    </div>
                    <div class="card-value">${stats.usage.requestsLast24h}</div>
                    <div class="card-trend">
                        <span class="badge badge-success">Média: ${stats.usage.averagePerHour}/h</span>
                    </div>
                </div>
            `;
        }

        function renderRecentActivity(activities) {
            const tbody = document.querySelector('#recent-activity-table tbody');

            if (!activities || activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Nenhuma atividade recente</td></tr>';
                return;
            }

            tbody.innerHTML = activities.map(activity => `
                <tr>
                    <td><span class="badge badge-info">${activity.action}</span></td>
                    <td>${activity.apiKeyName || 'N/A'}</td>
                    <td>${activity.apiKeyType || 'N/A'}</td>
                    <td>${new Date(activity.createdAt).toLocaleString('pt-BR')}</td>
                </tr>
            `).join('');
        }

        function renderKeysTable(keys) {
            const tbody = document.querySelector('#keys-table tbody');

            if (!keys || keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nenhuma API Key encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = keys.map(key => {
                const statusBadge = key.isActive
                    ? '<span class="badge badge-success">Ativa</span>'
                    : '<span class="badge badge-danger">Inativa</span>';

                const typeBadge = key.type === 'admin'
                    ? '<span class="badge badge-admin">Admin</span>'
                    : '<span class="badge badge-info">Normal</span>';

                const subscriptionBadge = key.subscription
                    ? (key.subscription.enabled && key.subscription.status === 'active'
                        ? '<span class="badge badge-success">Ativa</span>'
                        : '<span class="badge badge-danger">Expirada</span>')
                    : '<span class="badge badge-warning">Nenhuma</span>';

                const daysRemaining = key.subscription
                    ? `<span style="font-size: 0.875rem; color: var(--secondary);">${key.subscription.daysRemaining ?? 0} dias</span>`
                    : '-';

                return `
                    <tr>
                        <td>
                            <strong>${key.name}</strong><br>
                            <small style="color: var(--secondary);">${maskApiKey(key.keyValue)}</small>
                        </td>
                        <td><code>${key.uid.substring(0, 8)}...</code></td>
                        <td>${typeBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${key.usageCount}</td>
                        <td>${subscriptionBadge}<br>${daysRemaining}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewKey('${key.uid}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${key.subscription && key.subscription.enabled ? `
                                <button class="btn btn-sm btn-success" onclick="openRenewModal('${key.uid}')">
                                    <i class="fas fa-sync"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteKey('${key.uid}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderSubscriptionsTable(subscriptions) {
            const tbody = document.querySelector('#subscriptions-table tbody');

            if (!subscriptions || subscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhuma assinatura encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = subscriptions.map(sub => {
                const statusBadge = sub.status === 'active'
                    ? '<span class="badge badge-success">Ativa</span>'
                    : (sub.status === 'expiring'
                        ? '<span class="badge badge-warning">Expirando</span>'
                        : '<span class="badge badge-danger">Expirada</span>');

                const daysRemaining = Math.max(0, sub.daysRemaining);
                const daysBadge = daysRemaining <= 7
                    ? `<span class="badge badge-danger">${daysRemaining} dias</span>`
                    : `<span class="badge badge-success">${daysRemaining} dias</span>`;

                return `
                    <tr>
                        <td>
                            <strong>${sub.apiKey.name}</strong><br>
                            <small>${sub.apiKey.uid.substring(0, 8)}...</small>
                        </td>
                        <td>R$ ${sub.price.toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>${new Date(sub.startDate).toLocaleDateString('pt-BR')}</td>
                        <td>${new Date(sub.endDate).toLocaleDateString('pt-BR')}</td>
                        <td>${daysBadge}</td>
                        <td>${sub.autoRenew ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : '<i class="fas fa-times-circle" style="color: var(--secondary);"></i>'}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="openRenewModal('${sub.apiKey.uid}')">
                                <i class="fas fa-sync"></i> Renovar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderRevenueCards(stats, revenue) {
            const container = document.getElementById('revenue-cards');
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Receita Total</span>
                        <i class="fas fa-dollar-sign" style="color: var(--success);"></i>
                    </div>
                    <div class="card-value">R$ ${stats.revenue.total.toFixed(2)}</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Últimos 30 Dias</span>
                        <i class="fas fa-calendar" style="color: var(--primary);"></i>
                    </div>
                    <div class="card-value">R$ ${stats.revenue.last30Days.toFixed(2)}</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Total de Pagamentos</span>
                        <i class="fas fa-receipt" style="color: var(--warning);"></i>
                    </div>
                    <div class="card-value">${revenue.summary.totalPayments}</div>
                </div>
            `;
        }

        function renderPaymentsTable(payments) {
            const tbody = document.querySelector('#payments-table tbody');

            if (!payments || payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nenhum pagamento encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td><code>${payment.reference}</code></td>
                    <td>${payment.apiKeyName}</td>
                    <td><span class="badge badge-success">R$ ${payment.amount.toFixed(2)}</span></td>
                    <td>${payment.method || 'manual'}</td>
                    <td>${new Date(payment.paymentDate).toLocaleString('pt-BR')}</td>
                </tr>
            `).join('');
        }

        function renderLogsTimeline(activities) {
            const container = document.getElementById('logs-timeline');

            if (!activities || activities.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>Nenhuma atividade registrada</p></div>';
                return;
            }

            const actionIcons = {
                'create_api_key': 'fa-plus',
                'update_api_key': 'fa-edit',
                'delete_api_key': 'fa-trash',
                'activate_subscription': 'fa-credit-card',
                'renew_subscription': 'fa-sync',
                'cancel_subscription': 'fa-times',
                'admin_login': 'fa-sign-in-alt',
            };

            container.innerHTML = activities.map(activity => `
                <div class="timeline-item">
                    <div class="timeline-icon">
                        <i class="fas ${actionIcons[activity.action] || 'fa-circle'}"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-title">${activity.action}</div>
                        <div class="timeline-meta">
                            ${activity.apiKeyName ? `${activity.apiKeyName} - ` : ''}
                            ${new Date(activity.createdAt).toLocaleString('pt-BR')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // KEY OPERATIONS
        // ==========================================
        async function createKey(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            if (data.enableSubscription) {
                data.subscription = {
                    enabled: true,
                    price: parseFloat(data.price),
                    durationDays: parseInt(data.durationDays),
                    autoRenew: data.autoRenew === 'on',
                };
            } else {
                data.subscription = null;
            }

            delete data.enableSubscription;
            delete data.price;
            delete data.durationDays;
            delete data.autoRenew;

            try {
                const response = await api.createKey(data);
                showToast('API Key criada com sucesso!', 'success');
                closeModal('create-key-modal');
                loadKeys();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function viewKey(uid) {
            try {
                const response = await api.getKey(uid);

                const content = document.getElementById('view-key-content');
                content.innerHTML = `
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" value="${response.apiKey.name}" readonly>
                    </div>
                    <div class="form-group">
                        <label>UID</label>
                        <input type="text" value="${response.apiKey.uid}" readonly>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="text" value="${response.apiKey.keyValue}" readonly style="font-family: monospace;">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <input type="text" value="${response.apiKey.type}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <input type="text" value="${response.apiKey.isActive ? 'Ativa' : 'Inativa'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Uso</label>
                        <input type="text" value="${response.apiKey.usageCount} requisições" readonly>
                    </div>
                    <div class="form-group">
                        <label>Último Uso</label>
                        <input type="text" value="${response.apiKey.lastUsedAt ? new Date(response.apiKey.lastUsedAt).toLocaleString('pt-BR') : 'Nunca'}" readonly>
                    </div>
                    ${response.apiKey.subscription ? `
                        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border);">
                        <h3 style="margin-bottom: 1rem;">Assinatura</h3>
                        <div class="form-group">
                            <label>Preço</label>
                            <input type="text" value="R$ ${response.apiKey.subscription.price.toFixed(2)}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <input type="text" value="${response.apiKey.subscription.status}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Início</label>
                            <input type="text" value="${new Date(response.apiKey.subscription.startDate).toLocaleString('pt-BR')}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Fim</label>
                            <input type="text" value="${new Date(response.apiKey.subscription.endDate).toLocaleString('pt-BR')}" readonly>
                        </div>
                    ` : ''}
                `;

                openModal('view-key-modal');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteKey(uid) {
            if (!confirm('Tem certeza que deseja excluir esta API Key? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                await api.deleteKey(uid);
                showToast('API Key excluída com sucesso!', 'success');
                loadKeys();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function renewSubscription(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await api.renewSubscription(data.keyUid, {
                    durationDays: parseInt(data.durationDays),
                    paymentReference: data.paymentReference,
                    amount: data.amount ? parseFloat(data.amount) : undefined,
                });

                showToast('Assinatura renovada com sucesso!', 'success');
                closeModal('renew-subscription-modal');
                loadKeys();
                loadSubscriptions();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function openRenewModal(uid) {
            document.getElementById('renew-key-uid').value = uid;
            openModal('renew-subscription-modal');
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function maskApiKey(apiKey) {
            if (apiKey.length < 8) return '****';
            const start = apiKey.substring(0, 4);
            const end = apiKey.substring(apiKey.length - 4);
            return `${start}****${end}`;
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ==========================================
        // AUTO REFRESH & INACTIVITY
        // ==========================================
        function startAutoRefresh() {
            stopAutoRefresh();

            AppState.autoRefreshInterval = setInterval(async () => {
                try {
                    if (AppState.isAuthenticated) {
                        await loadDashboardData();
                    }
                } catch (error) {
                    console.error('Auto refresh error:', error);
                }
            }, 5000); // Refresh every 5 seconds
        }

        function stopAutoRefresh() {
            if (AppState.autoRefreshInterval) {
                clearInterval(AppState.autoRefreshInterval);
                AppState.autoRefreshInterval = null;
            }
        }

        function resetInactivityTimer() {
            clearTimeout(AppState.inactivityTimer);

            AppState.inactivityTimer = setTimeout(() => {
                handleLogout();
                showToast('Sessão expirada por inatividade', 'warning');
            }, 15 * 60 * 1000); // 15 minutes
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    switchPage(page);
                });
            });

            // Create key modal
            document.getElementById('create-key-btn').addEventListener('click', () => {
                openModal('create-key-modal');
            });

            document.getElementById('close-create-modal').addEventListener('click', () => {
                closeModal('create-key-modal');
            });

            document.getElementById('create-key-form').addEventListener('submit', createKey);

            document.getElementById('enable-subscription').addEventListener('change', (e) => {
                document.getElementById('subscription-options').style.display = e.target.checked ? 'block' : 'none';
            });

            // View key modal
            document.getElementById('close-view-modal').addEventListener('click', () => {
                closeModal('view-key-modal');
            });

            // Renew subscription modal
            document.getElementById('close-renew-modal').addEventListener('click', () => {
                closeModal('renew-subscription-modal');
            });

            document.getElementById('renew-subscription-form').addEventListener('submit', renewSubscription);

            // Subscription filter
            document.getElementById('subscription-filter').addEventListener('change', loadSubscriptions);

            // Keys search
            document.getElementById('keys-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredKeys = AppState.apiKeys.filter(key =>
                    key.name.toLowerCase().includes(searchTerm) ||
                    key.uid.toLowerCase().includes(searchTerm)
                );
                renderKeysTable(filteredKeys);
            });

            // Settings form
            document.getElementById('settings-form').addEventListener('submit', (e) => {
                e.preventDefault();
                showToast('Configurações salvas!', 'success');
            });

            // Activity tracking
            ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer);
            });

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Check authentication on load
            checkAuth();
        });
    </script>
</body>
</html>
